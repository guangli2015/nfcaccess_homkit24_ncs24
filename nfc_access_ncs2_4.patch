From ab7fb5d715f1698c1e4e99ec354a8f2cc4d0a6b9 Mon Sep 17 00:00:00 2001
From: andrew li <andrew.li@nordicsemi.no>
Date: Thu, 19 Oct 2023 16:16:52 +0800
Subject: [PATCH] nfc lock 1019

---
 CMakeLists.txt                                |  7 +-
 adk/PAL/Mock/HAPPlatformNfcAccess.c           | 31 +++++--
 .../nrf52840dk_nrf52840.overlay               | 34 +++++++
 samples/lock/CMakeLists.txt                   |  1 +
 samples/lock/prj.conf                         | 11 +++
 samples/lock/prj_debug.conf                   | 27 +++++-
 samples/lock/src/tag_reader.c                 | 89 +++++++++++++++++++
 7 files changed, 192 insertions(+), 8 deletions(-)
 create mode 100644 samples/lock/src/tag_reader.c

diff --git a/CMakeLists.txt b/CMakeLists.txt
index c9b129e..7c2b8e6 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -82,6 +82,10 @@ if(CONFIG_HOMEKIT)
     target_compile_definitions(homekit_interface INTERFACE
       HAVE_NFC=1
       HAP_FEATURE_NFC=1
+      HAVE_NFC_ACCESS=1
+      HAP_FEATURE_NFC_ACCESS=1
+      HAVE_KEY_EXPORT=1
+      HAP_FEATURE_KEY_EXPORT=1
     )
   else()
     target_compile_definitions(homekit_interface INTERFACE
@@ -256,7 +260,7 @@ endif()
   FILE(GLOB app_generic_input adk/Applications/Common/Platform/AppUserInputGeneric.c)
   FILE(GLOB app_db adk/Applications/Common/DB/*.c)
   FILE(GLOB app_helper adk/Applications/Common/Helper/*.c)
-
+  FILE(GLOB adk_pal_nfc_access adk/PAL/nRF52/HAPPlatformNfcAccess.c)
   list(FILTER app_helper EXCLUDE REGEX .*/adk/Applications/Common/Helper/StandardInputHandler.c)
 
   
@@ -273,6 +277,7 @@ endif()
     ${app_generic_input}
     ${app_db}
     ${app_helper}
+	${adk_pal_nfc_access}
   )
   
   zephyr_library_include_directories(${ZEPHYR_BASE}/subsys/bluetooth/host)
diff --git a/adk/PAL/Mock/HAPPlatformNfcAccess.c b/adk/PAL/Mock/HAPPlatformNfcAccess.c
index 05c52cb..687b374 100644
--- a/adk/PAL/Mock/HAPPlatformNfcAccess.c
+++ b/adk/PAL/Mock/HAPPlatformNfcAccess.c
@@ -50,9 +50,19 @@
 #include "HAPCharacteristicTypes.h"
 #include "HAPCrypto.h"
 #include "HAPPlatform.h"
-
+#include <stdio.h>
+#include <stdint.h>
+#include <stdbool.h>
+#include <stdarg.h>
+#include <zephyr/kernel.h>
+#include <stdbool.h>
+#include <assert.h>
+#include <zephyr/sys/util.h>
+#include <zephyr/sys/byteorder.h>
+#include <string.h>
+#include <zephyr/logging/log.h>
 #if HAP_FEATURE_ENABLED(HAP_FEATURE_NFC_ACCESS)
-
+LOG_MODULE_DECLARE(st25r3916);
 /**
  * The salt value used with a key value to create a hash for the Identifier field
  */
@@ -319,6 +329,8 @@ static const HAPLogObject logObject = { .subsystem = kHAPPlatform_LogSubsystem,
  */
 #define kKeyValueStoreKeyConfigurationState ((HAPPlatformKeyValueStoreKey) 0x04)
 
+// add by andrew
+//extern uint8_t reader_SK[NFC_ACCESS_READER_KEY_BYTES];
 /**
  * Loads issuer key list into cache
  *
@@ -672,7 +684,7 @@ HAPError HAPPlatformNfcAccessCreate(
         HAPConfigurationStateChangeCallback _Nullable configurationStateChangeCallback,
         HAPNfcTransactionDetectedCallback _Nullable nfcTransactionDetectedCallback) {
     HAPPrecondition(keyValueStore);
-
+LOG_INF("HAPPlatformNfcAccessCreate^^^^^^^^^");
     nfcAccessPlatform.keyValueStore = keyValueStore;
     nfcAccessPlatform.storeDomain = storeDomain;
     nfcAccessPlatform.configurationStateChangeCallback = configurationStateChangeCallback;
@@ -1111,6 +1123,8 @@ HAPError HAPPlatformNfcAccessDeviceCredentialKeyAdd(
 
     // VENDOR-TODO: Either add device credential key to the reader or update the entry with a new key if the LRU is
     // evicted
+    //Add by andrew
+     //HAPRawBufferCopyBytes(reader_ePK, deviceCredentialKey->key, deviceCredentialKey->keyNumBytes);
 
     IncrementDeviceCredentialKeyNumEntries(deviceCredentialKey->state);
 
@@ -1240,7 +1254,7 @@ HAPError HAPPlatformNfcAccessReaderKeyAdd(
         NfcAccessStatusCode* _Nonnull statusCode) {
     HAPPrecondition(readerKey);
     HAPPrecondition(statusCode);
-
+LOG_INF("HAPPlatformNfcAccessReaderKeyAdd^^^^^^^^^");
     if (!nfcAccessPlatform.initialized) {
         HAPLogError(&logObject, "%s: Platform not initialized", __func__);
         return kHAPError_InvalidState;
@@ -1290,7 +1304,14 @@ HAPError HAPPlatformNfcAccessReaderKeyAdd(
     }
 
     // VENDOR-TODO: Add reader key to the reader
-
+        //Add by andrew
+ /*           LOG_INF("#############################\n ");
+  for(int i=0;i<32;i++)
+            {
+                LOG_INF("%x ",readerKey->key[i]);
+            }
+              LOG_INF("##############################\n ");
+     HAPRawBufferCopyBytes(reader_SK, readerKey->key, readerKey->keyNumBytes);*/
     *statusCode = NFC_ACCESS_STATUS_CODE_SUCCESS;
     return kHAPError_None;
 }
diff --git a/samples/common/configuration/nrf52840dk_nrf52840/nrf52840dk_nrf52840.overlay b/samples/common/configuration/nrf52840dk_nrf52840/nrf52840dk_nrf52840.overlay
index 0357cfa..994ba2f 100644
--- a/samples/common/configuration/nrf52840dk_nrf52840/nrf52840dk_nrf52840.overlay
+++ b/samples/common/configuration/nrf52840dk_nrf52840/nrf52840dk_nrf52840.overlay
@@ -11,6 +11,22 @@
 &pwm0 {
 	status = "disabled";
 };
+&spi0 {
+	compatible = "nordic,nrf-spi";
+	status = "okay";
+	cs-gpios = <&gpio1 12 GPIO_ACTIVE_LOW>;
+
+	pinctrl-0 = <&spi0_default_alt>;
+	pinctrl-1 = <&spi0_sleep_alt>;
+	pinctrl-names = "default", "sleep";
+	st25r3911b@0 {
+		compatible = "st,st25r3911b";
+		reg = <0>;
+		spi-max-frequency = <4000000>;
+		irq-gpios = <&gpio0 3 GPIO_ACTIVE_HIGH>;
+		led-nfca-gpios = <&gpio0 29 GPIO_ACTIVE_HIGH>;
+	};
+};
 &spi1 {
 	status = "disabled";
 };
@@ -20,3 +36,21 @@
 &usbd {
 	status = "disabled";
 };
+&pinctrl {
+	spi0_default_alt: spi0_default_alt {
+		group1 {
+			psels = <NRF_PSEL(SPIM_SCK, 1, 15)>,
+				<NRF_PSEL(SPIM_MOSI, 1, 13)>,
+				<NRF_PSEL(SPIM_MISO, 1, 14)>;
+		};
+	};
+
+	spi0_sleep_alt: spi0_sleep_alt {
+		group1 {
+			psels = <NRF_PSEL(SPIM_SCK, 1, 15)>,
+				<NRF_PSEL(SPIM_MOSI, 1, 13)>,
+				<NRF_PSEL(SPIM_MISO, 1, 14)>;
+			low-power-enable;
+		};
+	};
+};
diff --git a/samples/lock/CMakeLists.txt b/samples/lock/CMakeLists.txt
index cdcd7a4..2feca22 100644
--- a/samples/lock/CMakeLists.txt
+++ b/samples/lock/CMakeLists.txt
@@ -45,6 +45,7 @@ find_package(Zephyr HINTS $ENV{ZEPHYR_BASE})
 project(homekit_lock)
 
 target_sources(app PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/src/app.c)
+target_sources(app PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/src/tag_reader.c)
 target_sources(app PRIVATE ${COMMON_ROOT}/src/main.c)
 target_sources(app PRIVATE ${COMMON_ROOT}/src/hap.c)
 
diff --git a/samples/lock/prj.conf b/samples/lock/prj.conf
index 684d8b9..3189b92 100644
--- a/samples/lock/prj.conf
+++ b/samples/lock/prj.conf
@@ -62,3 +62,14 @@ CONFIG_UART_CONSOLE=n
 
 # Stacks
 CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=4492
+
+
+CONFIG_SPI=y
+
+CONFIG_ST25R3916_LIB=y
+CONFIG_POLL=y
+
+
+
+CONFIG_ST25R3916_LIB_LOG_LEVEL_INF=y
+CONFIG_LOG_DEFAULT_LEVEL=4
diff --git a/samples/lock/prj_debug.conf b/samples/lock/prj_debug.conf
index 6994fc7..64ca40c 100644
--- a/samples/lock/prj_debug.conf
+++ b/samples/lock/prj_debug.conf
@@ -43,15 +43,18 @@ CONFIG_MCUBOOT_IMAGE_VERSION="1.0.0+0"
 CONFIG_BOOTLOADER_MCUBOOT=y
 
 # Miscellaneous
+CONFIG_MAIN_STACK_SIZE=4096
 CONFIG_MPU_STACK_GUARD=y
-CONFIG_HEAP_MEM_POOL_SIZE=1024
+CONFIG_HEAP_MEM_POOL_SIZE=4096
 CONFIG_ASSERT=n
 CONFIG_DK_LIBRARY=y
 CONFIG_REBOOT=y
 CONFIG_BOOT_BANNER=y
 
 # HomeKit Protocol
-CONFIG_HAP_LOG_LEVEL_DEBUG=y
+#CONFIG_HAP_LOG_LEVEL_DEBUG=y
+CONFIG_HAP_LOG_LEVEL_NONE=y
+#CONFIG_HAP_LOG_LEVEL_INFO=y
 CONFIG_HAP_ASSERTS=y
 CONFIG_HAP_PRECONDITIONS=y
 CONFIG_HAP_LOG_MESSAGE_MAX_BYTES=512
@@ -84,3 +87,23 @@ CONFIG_RESET_ON_FATAL_ERROR=n
 
 # Stacks
 CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=4492
+
+CONFIG_SPI=y
+
+CONFIG_ST25R3916_LIB=y
+CONFIG_POLL=y
+
+
+
+#CONFIG_ST25R3916_LIB_LOG_LEVEL_INF=y
+#CONFIG_LOG_DEFAULT_LEVEL=4
+
+# Enable nordic security backend and PSA APIs
+CONFIG_NRF_SECURITY=y
+CONFIG_MBEDTLS_PSA_CRYPTO_C=y
+
+CONFIG_MBEDTLS_ENABLE_HEAP=y
+CONFIG_MBEDTLS_HEAP_SIZE=8192
+
+# The Zephyr CMSIS emulation assumes that ticks are ms, currently
+CONFIG_SYS_CLOCK_TICKS_PER_SEC=1000
\ No newline at end of file
diff --git a/samples/lock/src/tag_reader.c b/samples/lock/src/tag_reader.c
new file mode 100644
index 0000000..5ae606f
--- /dev/null
+++ b/samples/lock/src/tag_reader.c
@@ -0,0 +1,89 @@
+/* main.c - Application main entry point */
+
+/*
+ * Copyright (c) 2019 Nordic Semiconductor ASA
+ *
+ * SPDX-License-Identifier: LicenseRef-Nordic-5-Clause
+ */
+
+#include <zephyr/types.h>
+#include <stddef.h>
+#include <stdbool.h>
+#include <string.h>
+#include <zephyr/kernel.h>
+#include <zephyr/sys/printk.h>
+//#include <st25r3911b_nfca.h>
+#include <nfc/ndef/msg_parser.h>
+#include <nfc/ndef/le_oob_rec_parser.h>
+#include <nfc/t2t/parser.h>
+#include <nfc/t4t/ndef_file.h>
+#include <nfc/t4t/isodep.h>
+#include <nfc/t4t/hl_procedure.h>
+#include <nfc/ndef/ch_rec_parser.h>
+#include <zephyr/sys/byteorder.h>
+#include <st25r3916_nfca.h>
+
+#include "st25r3916_irq.h"
+#include "rfal_nfc.h"
+#include "demo.h"
+#define MY_STACK_SIZE 1024
+#define MY_PRIORITY -2
+static K_SEM_DEFINE(irq_sem, 0, 1);
+//static K_SEM_DEFINE(rfal_sem, 0, 1);
+int is=0;
+
+
+
+void my_entry_point(int unused1, int unused2, int unused3)
+{
+	int err;
+	while(1){
+		err = k_sem_take(&irq_sem, K_FOREVER);
+		if (err) {
+			return;
+		}
+                
+		st25r3916Isr();
+               // k_sem_give(&rfal_sem);
+                //printk("&");
+
+	}
+
+}
+
+K_THREAD_STACK_DEFINE(my_stack_area, MY_STACK_SIZE);
+
+void tag_reader(int unused1, int unused2, int unused3)
+{
+	int err;
+    printk("@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n");
+#if 1
+	st25r3916InitInterrupts(&irq_sem);
+	struct k_thread my_thread_data;
+	
+	k_tid_t my_tid = k_thread_create(&my_thread_data, my_stack_area,
+									 K_THREAD_STACK_SIZEOF(my_stack_area),
+									 my_entry_point,
+									 NULL, NULL, NULL,
+									 MY_PRIORITY, 0, K_NO_WAIT);
+
+	err = st25r3916_nfca_init();
+	if (err) {
+		return err;
+	}
+
+#if 1
+if(demoIni())
+{
+        printk("init ok\n");
+         while(1)
+        {
+                demoCycle();
+
+                k_sleep(K_MSEC(30));
+        }
+}
+#endif
+#endif
+}
+K_THREAD_DEFINE(tag, 4096, tag_reader, NULL, NULL, NULL, 5, 0, 0);
-- 
2.33.0.windows.2

